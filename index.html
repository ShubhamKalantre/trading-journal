<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // simple localStorage-backed journal with image preview using FileReader
  const trades = JSON.parse(localStorage.getItem('trades-lite')||'[]');
  const tbody = document.querySelector('#tradeTable tbody');

  function save(){ localStorage.setItem('trades-lite', JSON.stringify(trades)); }

  function showToast(msg){
    const t = document.getElementById('toast');
    if(!t) return;
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),1800);
  }

  function render(){
    tbody.innerHTML='';
    trades.forEach((t,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${t.date}</td>
        <td>${t.market}</td>
        <td>${t.direction}</td>
        <td>${t.entry}</td>
        <td>${t.exit}</td>
        <td>${t.result}</td>
        <td>${t.tags||''}</td>
        <td>${t.screenshot?`<img src="${t.screenshot}" class="thumb">`:'-'}</td>
        <td><button class="delBtn" data-i="${i}">ğŸ—‘ï¸</button></td>
      `;
      tbody.appendChild(tr);
    });
    attachDeleteHandlers();
    updateKPIs();
    renderChart();
  }

  function updateKPIs(){
    document.getElementById('totalTrades').innerText=trades.length;
    const wins=trades.filter(t=>Number(t.result)>0).length;
    const total=trades.reduce((s,t)=>s+Number(t.result||0),0);
    document.getElementById('winRate').innerText=trades.length?((wins/trades.length*100).toFixed(1)+'%'):'0%';
    document.getElementById('totalPL').innerText=total.toFixed(2);
  }

  document.getElementById('tradeForm').addEventListener('submit', async e=>{
    e.preventDefault();
    const fileInput=document.getElementById('screenshot');
    let imgData=null;
    if(fileInput.files && fileInput.files[0]){
      imgData = await readFileAsDataURL(fileInput.files[0]);
    }
    // READ VALUES DIRECTLY FROM DOM (reliable)
    const t = {
      date: document.getElementById('date').value,
      market: document.getElementById('market').value,
      direction: document.getElementById('direction').value,
      entry: document.getElementById('entry').value,
      exit: document.getElementById('exit').value,
      result: document.getElementById('result').value,
      tags: document.getElementById('tags').value,
      screenshot: imgData
    };
    trades.push(t);
    save();
    render();
    // popup confirmation when a trade is added
    alert('Trade added successfully!');
    e.target.reset();
  });

  document.getElementById('filter').addEventListener('input', e=>{
    const q=e.target.value.toLowerCase();
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.style.display = (tr.children[1].innerText.toLowerCase().includes(q)) ? '' : 'none';
    });
  });

  document.getElementById('globalSearch').addEventListener('input', e=>{
    const q=e.target.value.toLowerCase();
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.style.display = (tr.innerText.toLowerCase().includes(q)) ? '' : 'none';
    });
  });

  function readFileAsDataURL(file){
    return new Promise(res=>{
      const r=new FileReader();
      r.onload=()=>res(r.result);
      r.readAsDataURL(file);
    });
  }

  // export CSV
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const rows=[['Date','Market','Direction','Entry','Exit','P/L','Tags']];
    trades.forEach(t=>rows.push([t.date,t.market,t.direction,t.entry,t.exit,t.result,(t.tags||'')]));
    const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='trades.csv'; a.click(); URL.revokeObjectURL(url);
  });

  // Delete handlers (confirm popup shown) & chart
  function attachDeleteHandlers(){
    document.querySelectorAll('.delBtn').forEach(btn=>{
      btn.onclick = ()=>{
        const i = parseInt(btn.dataset.i, 10);
        if (confirm('Delete this trade?')) {
          trades.splice(i,1);
          save();
          render();
          showToast('Trade deleted');
        }
      };
    });
  }

  let chart;
  function renderChart(){
    const pls = trades.map(t=>Number(t.result||0));
    let sum=0; const eq=[];
    pls.forEach(p=>{ sum+=p; eq.push(sum); });
    const canvas = document.getElementById('equityChart');
    if(!canvas) return;
    const ctx=canvas.getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels:eq.map((_,i)=>i+1), datasets:[{ label:'Equity', data:eq, fill:false, borderColor:'#2563eb'}] },
      options:{ responsive:true, plugins:{ legend:{ display:false } } }
    });
  }

  // initial render
  render();
</script>
